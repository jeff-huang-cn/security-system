# è®¤è¯æˆæƒç³»ç»Ÿå®Œæ•´æ–‡æ¡£

<style>
.mermaid rect {
    fill: #2c3e50 !important;
    stroke: #34495e !important;
}

.mermaid rect + text {
    fill: #ffffff !important;
    font-weight: bold !important;
}

.mermaid .rect text {
    fill: #ffffff !important;
    font-weight: bold !important;
}

.mermaid g.note text {
    fill: #ffffff !important;
    font-weight: bold !important;
}

.mermaid .node rect {
    fill: #2c3e50 !important;
    stroke: #34495e !important;
}

.mermaid .node text {
    fill: #ffffff !important;
    font-weight: bold !important;
}
</style>

## ç³»ç»Ÿæ¦‚è¿°

æœ¬ç³»ç»ŸåŸºäº **Spring Boot 2.7.5** å’Œ **Spring Security OAuth2 Authorization Server 0.4.5** æ„å»ºï¼Œé‡‡ç”¨å¾®æœåŠ¡æ¶æ„ï¼Œå®ç°äº†å®Œæ•´çš„ OAuth2 è®¤è¯æˆæƒå’Œ RBAC æƒé™ç®¡ç†ã€‚

### ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯åº”ç”¨      â”‚    â”‚   AdminæœåŠ¡     â”‚    â”‚   SSOæœåŠ¡       â”‚
â”‚  (React+TS)     â”‚    â”‚  (èµ„æºæœåŠ¡å™¨)   â”‚    â”‚  (è®¤è¯æœåŠ¡å™¨)   â”‚
â”‚  Port: 8082     â”‚    â”‚  Port: 9001     â”‚    â”‚  Port: 9000     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â”‚                       â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   MySQLæ•°æ®åº“   â”‚
                    â”‚   Port: 3306    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 1. SSO ç™»å½•æµç¨‹è¯¦è§£

### 1.1 ç™»å½•æ¥å£è°ƒç”¨æµç¨‹

```mermaid
sequenceDiagram
    participant F as å‰ç«¯åº”ç”¨<br/>(React+TS)<br/>Port: 8082
    participant S as SSOæœåŠ¡<br/>(è®¤è¯æœåŠ¡å™¨)<br/>Port: 9000
    participant D as æ•°æ®åº“<br/>(MySQL)<br/>Port: 3306
    participant A as AdminæœåŠ¡<br/>(èµ„æºæœåŠ¡å™¨)<br/>Port: 9001

    Note over F,A: ğŸ”µ è‡ªå®šä¹‰å®ç°  ğŸŸ¢ Spring Securityå†…éƒ¨

    F->>+S: <b>POST /oauth2/login</b><br/>ğŸ”µ {username, password}<br/>Header: X-Client-Id
    
    Note over S: ğŸ”µ <b>SSOæœåŠ¡ - ClientIdInterceptor</b><br/>æå–X-Client-Idåˆ°ThreadLocal
    
    S->>+S: ğŸ”µ <b>SSOæœåŠ¡ - OAuth2Controller.login()</b>
    S->>+S: ğŸ”µ <b>SSOæœåŠ¡ - è·å–RegisteredClient</b>
    S->>+S: ğŸŸ¢ <b>SSOæœåŠ¡ - AuthenticationManager.authenticate()</b>
    S->>+S: ğŸŸ¢ <b>SSOæœåŠ¡ - UserDetailsService.loadUserByUsername()</b>
    S->>+D: ğŸ”µ <b>æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯</b><br/>selectByUsername()
    D-->>-S: ğŸ”µ <b>è¿”å›ç”¨æˆ·åŸºæœ¬ä¿¡æ¯</b>
    S->>+D: ğŸ”µ <b>æŸ¥è¯¢ç”¨æˆ·æƒé™</b><br/>selectUserPermissions()
    D-->>-S: ğŸ”µ <b>è¿”å›æƒé™åˆ—è¡¨</b>
    S-->>-S: ğŸŸ¢ <b>SSOæœåŠ¡ - æ„å»ºUserDetailså¯¹è±¡</b><br/>åŒ…å«æƒé™ä¿¡æ¯
    S-->>-S: ğŸŸ¢ <b>SSOæœåŠ¡ - å¯†ç éªŒè¯</b>
    S->>+S: ğŸŸ¢ <b>SSOæœåŠ¡ - åˆ›å»ºAuthenticationå¯¹è±¡</b>
    S->>+S: ğŸ”µ <b>SSOæœåŠ¡ - ç”ŸæˆOAuth2Authorization</b>
    S->>+S: ğŸŸ¢ <b>SSOæœåŠ¡ - JWT Tokenç”Ÿæˆ</b>
    
    Note over S: ğŸŸ¢ <b>SSOæœåŠ¡ - JwtCustomizer</b><br/>ğŸ”µ æ·»åŠ æƒé™åˆ°JWT claims
    
    S->>+S: ğŸ”µ <b>SSOæœåŠ¡ - ä¿å­˜Authorizationè®°å½•</b>
    S-->>-F: ğŸ”µ <b>è¿”å›Tokenå“åº”</b><br/>{access_token, refresh_token}
    
    Note over F: ğŸ”µ <b>å‰ç«¯åº”ç”¨ - å­˜å‚¨Tokenåˆ°localStorage</b>
```

### 1.2 ç™»å½•æµç¨‹è¯¦ç»†æ­¥éª¤

#### æ­¥éª¤1: å‰ç«¯å‘èµ·ç™»å½•è¯·æ±‚
```typescript
// authService.ts
const response = await authApi.post('/oauth2/login', { 
  username, 
  password 
});
```

**å¤„ç†å†…å®¹:**
- å‰ç«¯ä½¿ç”¨ `authApi` å®ä¾‹å‘é€è¯·æ±‚
- è‡ªåŠ¨æºå¸¦ `X-Client-Id: webapp-client` å¤´éƒ¨
- è¯·æ±‚ä½“åŒ…å«ç”¨æˆ·åå’Œå¯†ç 

#### æ­¥éª¤2: SSOæœåŠ¡æ¥æ”¶è¯·æ±‚
```java
// OAuth2Controller.java
@PostMapping("/login")
public ResponseEntity<?> login(@RequestBody LoginRequest loginRequest)
```

**å¤„ç†å†…å®¹:**
- `ClientIdInterceptor` æ‹¦æˆªè¯·æ±‚ï¼Œæå– `X-Client-Id` åˆ° `ThreadLocal`
- éªŒè¯å®¢æˆ·ç«¯IDçš„æœ‰æ•ˆæ€§
- è·å– `RegisteredClient` é…ç½®ä¿¡æ¯

#### æ­¥éª¤3: ç”¨æˆ·è®¤è¯
```java
// UserDetailsServiceImpl.java
public UserDetails loadUserByUsername(String username)
```

**å¤„ç†å†…å®¹:**
- æŸ¥è¯¢ç”¨æˆ·åŸºæœ¬ä¿¡æ¯: `sysUserMapper.selectByUsername(username)`
- æŸ¥è¯¢ç”¨æˆ·æƒé™åˆ—è¡¨: `sysUserMapper.selectUserPermissions(userId)`
- æƒé™æŸ¥è¯¢SQL:
```sql
SELECT DISTINCT sp.perm_code 
FROM sys_user su 
JOIN sys_user_role sur ON su.user_id = sur.user_id 
JOIN sys_role sr ON sur.role_id = sr.role_id 
JOIN sys_role_permission srp ON sr.role_id = srp.role_id 
JOIN sys_permission sp ON srp.permission_id = sp.permission_id 
WHERE su.user_id = #{userId} 
AND su.status = 1 AND su.deleted = 0 
AND sr.status = 1 AND sr.deleted = 0 
AND sp.status = 1 AND sp.deleted = 0
```
- æ„å»º `UserDetails` å¯¹è±¡ï¼ŒåŒ…å«æƒé™ä¿¡æ¯

#### æ­¥éª¤4: JWT Tokenç”Ÿæˆ
```java
// JwtConfig.java
@Bean
public OAuth2TokenCustomizer<JwtEncodingContext> jwtCustomizer()
```

**å¤„ç†å†…å®¹:**
- Spring Security ç”ŸæˆåŸºç¡€ JWT Token
- `JwtCustomizer` å°†ç”¨æˆ·æƒé™æ·»åŠ åˆ° JWT claims ä¸­
- æƒé™ä¿¡æ¯å­˜å‚¨åœ¨ `authorities` å­—æ®µ

#### æ­¥éª¤5: è¿”å›è®¤è¯ç»“æœ
```json
{
  "success": true,
  "access_token": "eyJhbGciOiJSUzI1NiIs...",
  "refresh_token": "eyJhbGciOiJSUzI1NiIs...",
  "token_type": "Bearer",
  "expires_in": 3600,
  "refresh_expires_in": 7200
}
```

## 2. AdminæœåŠ¡ç”¨æˆ·ä¿¡æ¯è®¤è¯æµç¨‹

### 2.1 AdminæœåŠ¡JWTéªŒè¯è¯¦ç»†æµç¨‹å›¾

```mermaid
sequenceDiagram
    participant Client as å‰ç«¯å®¢æˆ·ç«¯<br/>(React+TS)<br/>Port: 8082
    participant Filter as BearerTokenAuthenticationFilter<br/>(AdminæœåŠ¡å†…éƒ¨)
    participant Manager as AuthenticationManager<br/>(AdminæœåŠ¡å†…éƒ¨)
    participant Provider as JwtAuthenticationProvider<br/>(AdminæœåŠ¡å†…éƒ¨)
    participant Decoder as JwtDecoder<br/>(AdminæœåŠ¡å†…éƒ¨)
    participant SSO as SSOæœåŠ¡<br/>(JWKç«¯ç‚¹)<br/>Port: 9000
    participant Converter as JwtAuthenticationConverter<br/>(AdminæœåŠ¡å†…éƒ¨-è‡ªå®šä¹‰)
    participant Context as SecurityContext<br/>(AdminæœåŠ¡å†…éƒ¨)
    
    Note over Client,Context: <b>AdminæœåŠ¡(Port: 9001)å†…éƒ¨JWTéªŒè¯æµç¨‹</b>
    
    Client->>+Filter: <b>HTTPè¯·æ±‚ + Authorization: Bearer {jwt}</b>
    
    rect rgb(220, 220, 220)
        Note over Filter: <b>AdminæœåŠ¡ - Spring Securityå†…éƒ¨ç»„ä»¶</b>
        Filter->>Filter: <b>1. resolveToken() æå–JWT</b>
        Filter->>Filter: <b>2. åˆ›å»ºBearerTokenAuthenticationToken</b>
        Filter->>+Manager: <b>3. authenticate(authRequest)</b>
    end
    
    rect rgb(220, 220, 220)
        Note over Manager,Provider: <b>AdminæœåŠ¡ - Spring Securityå†…éƒ¨ç»„ä»¶</b>
        Manager->>+Provider: <b>4. authenticate()</b>
        Provider->>+Decoder: <b>5. decode(jwt)</b>
    end
    
    rect rgb(220, 220, 220)
        Note over Decoder: <b>AdminæœåŠ¡ - Spring Securityå†…éƒ¨ç»„ä»¶</b>
        Decoder->>Decoder: <b>6. è§£æJWTå¤´éƒ¨è·å–kid</b>
        Decoder->>+SSO: <b>7. GET /.well-known/jwks.json</b>
        Note over SSO: <b>SSOæœåŠ¡æä¾›JWKå…¬é’¥</b>
        SSO-->>-Decoder: <b>8. è¿”å›JWK Set (RSAå…¬é’¥)</b>
        Decoder->>Decoder: <b>9. éªŒè¯JWTç­¾å (RS256)</b>
        Decoder->>Decoder: <b>10. éªŒè¯JWTå£°æ˜ (exp, issç­‰)</b>
        Decoder-->>-Provider: <b>11. è¿”å›Jwtå¯¹è±¡</b>
    end
    
    rect rgb(200, 240, 200)
        Note over Provider,Converter: <b>AdminæœåŠ¡ - è‡ªå®šä¹‰ç»„ä»¶</b>
        Provider->>+Converter: <b>12. convert(jwt)</b>
        Converter->>Converter: <b>13. æå–authoritieså£°æ˜</b>
        Converter-->>-Provider: <b>14. è¿”å›JwtAuthenticationToken</b>
    end
    
    rect rgb(220, 220, 220)
        Note over Provider,Context: <b>AdminæœåŠ¡ - Spring Securityå†…éƒ¨ç»„ä»¶</b>
        Provider-->>-Manager: <b>15. è¿”å›Authentication</b>
        Manager-->>-Filter: <b>16. è¿”å›è®¤è¯ç»“æœ</b>
        Filter->>Context: <b>17. å­˜å‚¨åˆ°SecurityContext</b>
        Filter-->>-Client: <b>18. ç»§ç»­è¿‡æ»¤å™¨é“¾</b>
    end
    
    Note over Client: <b>åç»­è¯·æ±‚å¯é€šè¿‡@PreAuthorizeéªŒè¯æƒé™</b>
```

### 2.2 TokenéªŒè¯æµç¨‹

```mermaid
sequenceDiagram
    participant F as å‰ç«¯åº”ç”¨<br/>(React+TS)<br/>Port: 8082
    participant A as AdminæœåŠ¡<br/>(èµ„æºæœåŠ¡å™¨)<br/>Port: 9001
    participant S as SSOæœåŠ¡<br/>(è®¤è¯æœåŠ¡å™¨)<br/>Port: 9000

    Note over F,S: ğŸ”µ è‡ªå®šä¹‰å®ç°  ğŸŸ¢ Spring Securityå†…éƒ¨

    F->>+A: <b>GET /api/users</b><br/>ğŸ”µ Header: Authorization: Bearer {token}
    
    Note over A: ğŸŸ¢ <b>AdminæœåŠ¡ - OAuth2ResourceServerConfigurer</b><br/>JWTéªŒè¯è¿‡æ»¤å™¨é“¾
    
    A->>+A: ğŸŸ¢ <b>AdminæœåŠ¡ - BearerTokenAuthenticationFilter</b><br/>æå–JWT Token
    A->>+S: ğŸŸ¢ <b>AdminæœåŠ¡ - JwtDecoderéªŒè¯Token</b><br/>è·å–JWKå…¬é’¥
    S-->>-A: ğŸŸ¢ <b>SSOæœåŠ¡ - è¿”å›JWKå…¬é’¥</b>
    A->>+A: ğŸŸ¢ <b>AdminæœåŠ¡ - éªŒè¯JWTç­¾åå’Œæœ‰æ•ˆæœŸ</b>
    A->>+A: ğŸŸ¢ <b>AdminæœåŠ¡ - JwtAuthenticationConverter</b><br/>ğŸ”µ æå–authoritieså­—æ®µ
    A->>+A: ğŸŸ¢ <b>AdminæœåŠ¡ - æ„å»ºAuthenticationå¯¹è±¡</b><br/>åŒ…å«æƒé™ä¿¡æ¯
    A->>+A: ğŸŸ¢ <b>AdminæœåŠ¡ - @PreAuthorizeéªŒè¯</b><br/>ğŸ”µ hasAuthority('USER_QUERY')
    A->>+A: ğŸ”µ <b>AdminæœåŠ¡ - UserController.getAllUsers()</b>
    A-->>-F: ğŸ”µ <b>è¿”å›ç”¨æˆ·åˆ—è¡¨</b>
```

### 2.3 è®¤è¯æµç¨‹è¯¦ç»†æ­¥éª¤

#### æ­¥éª¤1: å‰ç«¯æºå¸¦Tokenè¯·æ±‚
```typescript
// api.ts - businessApiè¯·æ±‚æ‹¦æˆªå™¨
config.headers.Authorization = `Bearer ${accessToken}`;
```

**å¤„ç†å†…å®¹:**
- å‰ç«¯è‡ªåŠ¨åœ¨è¯·æ±‚å¤´ä¸­æ·»åŠ  `Authorization: Bearer {access_token}`
- ä½¿ç”¨ `businessApi` å®ä¾‹å‘é€ä¸šåŠ¡è¯·æ±‚

#### æ­¥éª¤2: AdminæœåŠ¡JWTéªŒè¯è¯¦è§£

##### 2.1 Spring Securityè¿‡æ»¤å™¨é“¾é…ç½®
```java
// SecurityConfig.java
@Bean
public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
    http
        .authorizeRequests(authz -> authz
            .antMatchers("/api/**").authenticated()  // APIéœ€è¦è®¤è¯
            .anyRequest().authenticated())
        .oauth2ResourceServer(oauth2 -> oauth2      // é…ç½®ä¸ºOAuth2èµ„æºæœåŠ¡å™¨
            .jwt(jwt -> jwt.jwtAuthenticationConverter(jwtAuthenticationConverter())));
    return http.build();
}
```

##### 2.2 BearerTokenAuthenticationFilterå·¥ä½œæœºåˆ¶

**ğŸ”´ é‡è¦è¯´æ˜ï¼šè¿™æ˜¯AdminæœåŠ¡(Port: 9001)å†…éƒ¨çš„è¿‡æ»¤å™¨ï¼Œä¸æ˜¯è°ƒç”¨å¤–éƒ¨æœåŠ¡ï¼**

```java
// AdminæœåŠ¡å†…éƒ¨ - Spring Securityå†…éƒ¨æµç¨‹ï¼ˆç®€åŒ–ç‰ˆï¼‰
public class BearerTokenAuthenticationFilter extends OncePerRequestFilter {
    
    @Override
    protected void doFilterInternal(HttpServletRequest request, 
                                  HttpServletResponse response, 
                                  FilterChain filterChain) {
        
        // 1. ä»è¯·æ±‚å¤´æå–Bearer Token
        String token = resolveToken(request);
        if (token != null) {
            // 2. åˆ›å»ºBearerTokenAuthenticationToken
            BearerTokenAuthenticationToken authRequest = 
                new BearerTokenAuthenticationToken(token);
            
            // 3. å§”æ‰˜ç»™AuthenticationManagerè¿›è¡Œè®¤è¯
            Authentication authResult = 
                this.authenticationManager.authenticate(authRequest);
            
            // 4. å°†è®¤è¯ç»“æœå­˜å‚¨åˆ°SecurityContext
            SecurityContextHolder.getContext().setAuthentication(authResult);
        }
        
        filterChain.doFilter(request, response);
    }
    
    private String resolveToken(HttpServletRequest request) {
        String bearerToken = request.getHeader("Authorization");
        if (StringUtils.hasText(bearerToken) && bearerToken.startsWith("Bearer ")) {
            return bearerToken.substring(7); // ç§»é™¤"Bearer "å‰ç¼€
        }
        return null;
    }
}
```

##### 2.3 JwtAuthenticationProviderè®¤è¯æµç¨‹

```java
// AdminæœåŠ¡å†…éƒ¨ - Spring Securityå†…éƒ¨çš„JWTè®¤è¯æä¾›è€…
public class JwtAuthenticationProvider implements AuthenticationProvider {
    
    private final JwtDecoder jwtDecoder;
    private final JwtAuthenticationConverter jwtAuthenticationConverter;
    
    @Override
    public Authentication authenticate(Authentication authentication) {
        BearerTokenAuthenticationToken bearer = 
            (BearerTokenAuthenticationToken) authentication;
        
        // 1. è§£ç å’ŒéªŒè¯JWT
        Jwt jwt = this.jwtDecoder.decode(bearer.getToken());
        
        // 2. è½¬æ¢ä¸ºAuthenticationå¯¹è±¡
        AbstractAuthenticationToken token = 
            this.jwtAuthenticationConverter.convert(jwt);
        
        return token;
    }
}
```

##### 2.4 JwtDecoderè¯¦ç»†å·¥ä½œæµç¨‹

```java
// AdminæœåŠ¡çš„JWTè§£ç å™¨é…ç½®
// application.ymlä¸­é…ç½®çš„issuer-uriä¼šè‡ªåŠ¨é…ç½®JwtDecoder
spring:
  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: http://localhost:9000  # SSOæœåŠ¡åœ°å€
```

**ğŸ”´ JwtDecoderå†…éƒ¨å·¥ä½œæœºåˆ¶ (AdminæœåŠ¡å†…éƒ¨ç»„ä»¶):**

```java
// AdminæœåŠ¡å†…éƒ¨ - Spring Securityå†…éƒ¨å®ç°ï¼ˆç®€åŒ–ç‰ˆï¼‰
public class NimbusJwtDecoder implements JwtDecoder {
    
    private final JWKSource<SecurityContext> jwkSource;
    
    @Override
    public Jwt decode(String token) throws JwtException {
        
        // 1. è§£æJWTå¤´éƒ¨ï¼Œè·å–kidï¼ˆå¯†é’¥IDï¼‰
        JWSHeader header = parseHeader(token);
        String keyId = header.getKeyID();
        
        // 2. ä»JWK Setè·å–å¯¹åº”çš„å…¬é’¥
        // ğŸ”´ è¿™é‡ŒAdminæœåŠ¡ä¼šå‘SSOæœåŠ¡(Port: 9000)çš„ /.well-known/jwks.json ç«¯ç‚¹è¯·æ±‚
        JWK jwk = this.jwkSource.get(keyId);
        RSAKey rsaKey = (RSAKey) jwk;
        
        // 3. éªŒè¯JWTç­¾å
        JWSVerifier verifier = new RSASSAVerifier(rsaKey.toRSAPublicKey());
        SignedJWT signedJWT = SignedJWT.parse(token);
        
        if (!signedJWT.verify(verifier)) {
            throw new JwtValidationException("JWT signature validation failed");
        }
        
        // 4. éªŒè¯JWTå£°æ˜ï¼ˆè¿‡æœŸæ—¶é—´ã€å‘è¡Œè€…ç­‰ï¼‰
        JWTClaimsSet claims = signedJWT.getJWTClaimsSet();
        validateClaims(claims);
        
        // 5. æ„å»ºJwtå¯¹è±¡
        return createJwt(token, claims);
    }
    
    private void validateClaims(JWTClaimsSet claims) {
        // éªŒè¯è¿‡æœŸæ—¶é—´
        Date expirationTime = claims.getExpirationTime();
        if (expirationTime != null && expirationTime.before(new Date())) {
            throw new JwtValidationException("JWT has expired");
        }
        
        // éªŒè¯å‘è¡Œè€…
        String issuer = claims.getIssuer();
        if (!expectedIssuer.equals(issuer)) {
            throw new JwtValidationException("Invalid issuer");
        }
        
        // éªŒè¯å—ä¼—ç­‰å…¶ä»–å£°æ˜...
    }
}
```

##### 2.5 JWKå…¬é’¥è·å–æœºåˆ¶

**ğŸ”´ AdminæœåŠ¡(Port: 9001)å¦‚ä½•è·å–SSOæœåŠ¡(Port: 9000)çš„å…¬é’¥:**

```java
// AdminæœåŠ¡å†…éƒ¨ - Spring Bootè‡ªåŠ¨é…ç½®ä¼šåˆ›å»ºJwtDecoder
@Configuration
public class OAuth2ResourceServerJwtConfiguration {
    
    @Bean
    @ConditionalOnProperty(name = "spring.security.oauth2.resourceserver.jwt.issuer-uri")
    public JwtDecoder jwtDecoder(OAuth2ResourceServerProperties properties) {
        String issuerUri = properties.getJwt().getIssuerUri();
        
        // æ„å»ºJWK Set URI: {issuerUri}/.well-known/jwks.json
        String jwkSetUri = issuerUri + "/.well-known/jwks.json";
        
        // åˆ›å»ºåŸºäºJWK Set URIçš„è§£ç å™¨
        return NimbusJwtDecoder.withJwkSetUri(jwkSetUri)
            .cache(Duration.ofMinutes(5))  // ç¼“å­˜5åˆ†é’Ÿ
            .build();
    }
}
```

**ğŸ”´ å®é™…çš„HTTPè¯·æ±‚æµç¨‹ (æœåŠ¡é—´é€šä¿¡):**

```
AdminæœåŠ¡(Port: 9001) --> GET http://localhost:9000/.well-known/jwks.json
SSOæœåŠ¡(Port: 9000)   --> è¿”å›JWK Set JSON:
{
  "keys": [
    {
      "kty": "RSA",
      "kid": "webapp-key-2024",
      "use": "sig",
      "alg": "RS256",
      "n": "0vx7agoebGcQSuuPiLJXZptN9nndrQmbXEps2aiAFbWhM78LhWx4cbbfAAtVT86zwu1RK7aPFFxuhDR1L6tSoc_BJECPebWKRXjBZCiFV4n3oknjhMstn64tZ_2W-5JsGY4Hc5n9yBXArwl93lqt7_RN5w6Cf0h4QyQ5v-65YGjQR0_FDW2QvzqY368QQMicAtaSqzs8KJZgnYb9c7d0zgdAZHzu6qMQvRL5hajrn1n91CbOpbISD08qNLyrdkt-bFTWhAI4vMQFh6WeZu0fM4lFd2NcRwr3XPksINHaQ-G_xBniIqbw0Ls1jF44-csFCur-kEgU8awapJzKnqDKgw",
      "e": "AQAB"
    }
  ]
}
```

##### 2.6 AdminæœåŠ¡å¯åŠ¨æ—¶çš„è‡ªåŠ¨é…ç½®

**ğŸ”´ AdminæœåŠ¡(Port: 9001) - Spring Bootå¦‚ä½•è‡ªåŠ¨é…ç½®è¿™äº›ç»„ä»¶:**

```java
// AdminæœåŠ¡å†…éƒ¨ - Spring Bootå¯åŠ¨æ—¶çš„è‡ªåŠ¨é…ç½®æµç¨‹
@Configuration
@ConditionalOnClass({JwtDecoder.class, OAuth2ResourceServerProperties.class})
public class OAuth2ResourceServerJwtConfiguration {
    
    // 1. è¯»å–application.ymlé…ç½®
    @ConfigurationProperties("spring.security.oauth2.resourceserver.jwt")
    public static class JwtProperties {
        private String issuerUri = "http://localhost:9000";
        // getter/setter...
    }
    
    // 2. è‡ªåŠ¨åˆ›å»ºJwtDecoder Bean
    @Bean
    @ConditionalOnMissingBean
    public JwtDecoder jwtDecoder(JwtProperties properties) {
        String jwkSetUri = properties.getIssuerUri() + "/.well-known/jwks.json";
        return NimbusJwtDecoder.withJwkSetUri(jwkSetUri)
            .cache(Duration.ofMinutes(5))  // ç¼“å­˜JWK 5åˆ†é’Ÿ
            .build();
    }
    
    // 3. è‡ªåŠ¨åˆ›å»ºJwtAuthenticationProvider
    @Bean
    @ConditionalOnMissingBean
    public JwtAuthenticationProvider jwtAuthenticationProvider(
            JwtDecoder jwtDecoder, 
            JwtAuthenticationConverter jwtAuthenticationConverter) {
        JwtAuthenticationProvider provider = new JwtAuthenticationProvider(jwtDecoder);
        provider.setJwtAuthenticationConverter(jwtAuthenticationConverter);
        return provider;
    }
    
    // 4. è‡ªåŠ¨é…ç½®AuthenticationManager
    @Bean
    @ConditionalOnMissingBean
    public AuthenticationManager authenticationManager(
            List<AuthenticationProvider> providers) {
        return new ProviderManager(providers);
    }
    
    // 5. è‡ªåŠ¨æ·»åŠ BearerTokenAuthenticationFilteråˆ°è¿‡æ»¤å™¨é“¾
    @Bean
    public BearerTokenAuthenticationFilter bearerTokenAuthenticationFilter(
            AuthenticationManager authenticationManager) {
        return new BearerTokenAuthenticationFilter(authenticationManager);
    }
}
```

**ğŸ”´ AdminæœåŠ¡(Port: 9001)å¯åŠ¨æ—¥å¿—ç¤ºä¾‹:**
```
2024-01-15 10:30:15.123  INFO --- [main] o.s.s.o.r.j.JwtDecoder : 
    [AdminæœåŠ¡] Configured JWT decoder with JWK Set URI: http://localhost:9000/.well-known/jwks.json

2024-01-15 10:30:15.456  INFO --- [main] o.s.s.w.DefaultSecurityFilterChain : 
    [AdminæœåŠ¡] Will secure any request with [
        ...
        BearerTokenAuthenticationFilter,
        ...
    ]

2024-01-15 10:30:15.789  INFO --- [main] o.s.b.w.embedded.tomcat.TomcatWebServer : 
    [AdminæœåŠ¡] Tomcat started on port(s): 9001 (http) with context path ''
```

**ğŸ”´ å¤„ç†å†…å®¹æ€»ç»“ (æ˜ç¡®æœåŠ¡å½’å±):**
1. **Tokenæå–**: AdminæœåŠ¡å†…éƒ¨çš„ `BearerTokenAuthenticationFilter` ä» `Authorization` å¤´éƒ¨æå– JWT Token
2. **å…¬é’¥è·å–**: AdminæœåŠ¡å†…éƒ¨çš„ `JwtDecoder` å‘ SSOæœåŠ¡(Port: 9000) çš„ `/.well-known/jwks.json` ç«¯ç‚¹è·å– JWK å…¬é’¥ï¼ˆå¸¦ç¼“å­˜ï¼‰
3. **ç­¾åéªŒè¯**: AdminæœåŠ¡å†…éƒ¨ä½¿ç”¨ RSA å…¬é’¥éªŒè¯ JWT çš„ RS256 ç­¾å
4. **å£°æ˜éªŒè¯**: AdminæœåŠ¡å†…éƒ¨éªŒè¯ Token çš„æœ‰æ•ˆæœŸã€å‘è¡Œè€…ã€å—ä¼—ç­‰å£°æ˜
5. **æƒé™æå–**: AdminæœåŠ¡å†…éƒ¨é€šè¿‡è‡ªå®šä¹‰çš„ `JwtAuthenticationConverter` ä» JWT çš„ `authorities` å­—æ®µæå–æƒé™ä¿¡æ¯
6. **è‡ªåŠ¨é…ç½®**: AdminæœåŠ¡å¯åŠ¨æ—¶ï¼ŒSpring Boot æ ¹æ® `application.yml` ä¸­çš„ `issuer-uri` è‡ªåŠ¨é…ç½®æ‰€æœ‰å¿…è¦ç»„ä»¶

#### æ­¥éª¤3: æƒé™ä¿¡æ¯æå–
```java
// SecurityConfig.java - JwtAuthenticationConverter
authoritiesConverter.setAuthoritiesClaimName("authorities");
authoritiesConverter.setAuthorityPrefix("");
```

**å¤„ç†å†…å®¹:**
- ä» JWT çš„ `authorities` å­—æ®µæå–æƒé™ä¿¡æ¯
- ç§»é™¤é»˜è®¤çš„ `SCOPE_` å‰ç¼€
- æ„å»º `Authentication` å¯¹è±¡ï¼ŒåŒ…å«ç”¨æˆ·æƒé™

#### æ­¥éª¤4: æ–¹æ³•çº§æƒé™éªŒè¯
```java
// UserController.java
@PreAuthorize("hasAuthority('USER_QUERY')")
public ResponseEntity<List<SysUser>> getAllUsers()
```

**å¤„ç†å†…å®¹:**
- Spring Security çš„ `@PreAuthorize` æ³¨è§£éªŒè¯æƒé™
- æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦å…·æœ‰ `USER_QUERY` æƒé™
- æƒé™éªŒè¯é€šè¿‡åæ‰§è¡Œä¸šåŠ¡é€»è¾‘

### 2.4 æƒé™éªŒè¯æœºåˆ¶

#### RBACæƒé™æ¨¡å‹
```
ç”¨æˆ·(User) â”€â”€â†’ ç”¨æˆ·è§’è‰²(UserRole) â”€â”€â†’ è§’è‰²(Role) â”€â”€â†’ è§’è‰²æƒé™(RolePermission) â”€â”€â†’ æƒé™(Permission)
```

#### æƒé™ç±»å‹
- **èœå•æƒé™**: æ§åˆ¶é¡µé¢è®¿é—® (perm_type = 1)
- **æ“ä½œæƒé™**: æ§åˆ¶åŠŸèƒ½æ“ä½œ (perm_type = 2)

#### æƒé™ç¼–ç ç¤ºä¾‹
- `USER_QUERY`: ç”¨æˆ·æŸ¥è¯¢æƒé™
- `USER_CREATE`: ç”¨æˆ·åˆ›å»ºæƒé™  
- `USER_UPDATE`: ç”¨æˆ·æ›´æ–°æƒé™
- `USER_DELETE`: ç”¨æˆ·åˆ é™¤æƒé™

## 3. æ ¸å¿ƒé…ç½®è¯´æ˜

### 3.1 SSOæœåŠ¡é…ç½®

#### OAuth2å®¢æˆ·ç«¯é…ç½®
```sql
-- oauth2_registered_clientè¡¨
INSERT INTO oauth2_registered_client VALUES (
    'webapp-client',
    'webapp-client',
    '{bcrypt}$2a$10$...',  -- å®¢æˆ·ç«¯å¯†é’¥
    'client_secret_basic',
    'authorization_code,refresh_token,client_credentials',
    'http://localhost:8080/login/oauth2/code/webapp-client',
    'read,write,openid,profile',
    '{"settings.client.require-authorization-consent":false}',
    '{"settings.token.access-token-time-to-live":["java.time.Duration",3600.000000000]}'
);
```

#### JWTé…ç½®
```java
// JwtConfig.java
@Bean
public OAuth2TokenCustomizer<JwtEncodingContext> jwtCustomizer() {
    return context -> {
        if (context.getTokenType().getValue().equals("access_token")) {
            Collection<? extends GrantedAuthority> authorities = 
                context.getPrincipal().getAuthorities();
            List<String> authoritiesList = authorities.stream()
                .map(GrantedAuthority::getAuthority)
                .collect(Collectors.toList());
            context.getClaims().claim("authorities", authoritiesList);
        }
    };
}
```

### 3.2 AdminæœåŠ¡é…ç½®

#### èµ„æºæœåŠ¡å™¨é…ç½®
```yaml
# application.yml
spring:
  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: http://localhost:9000
```

#### JWTæƒé™è½¬æ¢å™¨
```java
// SecurityConfig.java
@Bean
public JwtAuthenticationConverter jwtAuthenticationConverter() {
    JwtGrantedAuthoritiesConverter authoritiesConverter = 
        new JwtGrantedAuthoritiesConverter();
    authoritiesConverter.setAuthoritiesClaimName("authorities");
    authoritiesConverter.setAuthorityPrefix("");
    
    JwtAuthenticationConverter jwtConverter = new JwtAuthenticationConverter();
    jwtConverter.setJwtGrantedAuthoritiesConverter(authoritiesConverter);
    return jwtConverter;
}
```

## 4. å®‰å…¨ç‰¹æ€§

### 4.1 Tokenå®‰å…¨
- **RSAç­¾å**: ä½¿ç”¨RSA-256ç®—æ³•ç­¾åJWT
- **å¯†é’¥è½®æ¢**: æ”¯æŒJWKå¯†é’¥è½®æ¢æœºåˆ¶
- **Tokenè¿‡æœŸ**: Access Token 1å°æ—¶ï¼ŒRefresh Token 2å°æ—¶

### 4.2 æƒé™å®‰å…¨
- **æœ€å°æƒé™åŸåˆ™**: ç”¨æˆ·åªè·å¾—å¿…éœ€çš„æƒé™
- **æƒé™ç»§æ‰¿**: é€šè¿‡è§’è‰²ç»§æ‰¿æƒé™
- **åŠ¨æ€æƒé™**: æ”¯æŒè¿è¡Œæ—¶æƒé™å˜æ›´

### 4.3 ä¼šè¯å®‰å…¨
- **æ— çŠ¶æ€**: åŸºäºJWTçš„æ— çŠ¶æ€è®¤è¯
- **è‡ªåŠ¨åˆ·æ–°**: å‰ç«¯è‡ªåŠ¨å¤„ç†Tokenåˆ·æ–°
- **å®‰å…¨å­˜å‚¨**: Tokenå­˜å‚¨åœ¨localStorageä¸­

## 5. æµç¨‹å›¾æ€»ç»“

### 5.1 å®Œæ•´è®¤è¯æˆæƒæµç¨‹

```mermaid
graph TD
    A[å‰ç«¯ç™»å½•è¯·æ±‚<br/>Port: 8082] --> B[SSOæœåŠ¡éªŒè¯<br/>Port: 9000]
    B --> C[æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯<br/>MySQL: 3306]
    C --> D[æŸ¥è¯¢ç”¨æˆ·æƒé™<br/>MySQL: 3306]
    D --> E[SSOæœåŠ¡ç”ŸæˆJWT Token<br/>Port: 9000]
    E --> F[SSOæœåŠ¡è¿”å›Token<br/>Port: 9000]
    F --> G[å‰ç«¯å­˜å‚¨Token<br/>Port: 8082]
    G --> H[ä¸šåŠ¡è¯·æ±‚æºå¸¦Token<br/>Port: 8082]
    H --> I[AdminæœåŠ¡éªŒè¯Token<br/>Port: 9001]
    I --> J[AdminæœåŠ¡æå–æƒé™ä¿¡æ¯<br/>Port: 9001]
    J --> K[AdminæœåŠ¡@PreAuthorizeéªŒè¯<br/>Port: 9001]
    K --> L[AdminæœåŠ¡æ‰§è¡Œä¸šåŠ¡é€»è¾‘<br/>Port: 9001]
    
    style A fill:#e1f5fe
    style B fill:#e8f5e8
    style C fill:#e1f5fe
    style D fill:#e1f5fe
    style E fill:#e8f5e8
    style F fill:#e8f5e8
    style G fill:#e1f5fe
    style H fill:#e1f5fe
    style I fill:#e8f5e8
    style J fill:#e8f5e8
    style K fill:#e8f5e8
    style L fill:#e1f5fe
```

### 5.2 æƒé™éªŒè¯æµç¨‹

```mermaid
graph LR
    A[ç”¨æˆ·<br/>MySQL] --> B[è§’è‰²<br/>MySQL]
    B --> C[æƒé™<br/>MySQL]
    C --> D[JWT Token<br/>SSOæœåŠ¡: 9000]
    D --> E[AdminæœåŠ¡<br/>Port: 9001]
    E --> F[@PreAuthorize<br/>AdminæœåŠ¡]
    F --> G[ä¸šåŠ¡æ–¹æ³•<br/>AdminæœåŠ¡]
    
    style A fill:#e1f5fe
    style B fill:#e1f5fe
    style C fill:#e1f5fe
    style D fill:#e8f5e8
    style E fill:#e8f5e8
    style F fill:#e8f5e8
    style G fill:#e1f5fe
```

## 6. å…³é”®æŠ€æœ¯ç‚¹

### 6.1 Spring Securityå†…éƒ¨æœºåˆ¶
- **AuthenticationManager**: è®¤è¯ç®¡ç†å™¨
- **UserDetailsService**: ç”¨æˆ·è¯¦æƒ…æœåŠ¡
- **JwtDecoder**: JWTè§£ç å™¨
- **OAuth2ResourceServer**: èµ„æºæœåŠ¡å™¨é…ç½®

### 6.2 è‡ªå®šä¹‰å®ç°
- **ClientIdInterceptor**: å®¢æˆ·ç«¯IDæ‹¦æˆªå™¨
- **OAuth2Controller**: è‡ªå®šä¹‰ç™»å½•æ§åˆ¶å™¨
- **JwtCustomizer**: JWTè‡ªå®šä¹‰å™¨
- **UserDetailsServiceImpl**: ç”¨æˆ·è¯¦æƒ…æœåŠ¡å®ç°

### 6.3 æ•°æ®åº“è®¾è®¡
- **ç”¨æˆ·è¡¨**: sys_user
- **è§’è‰²è¡¨**: sys_role  
- **æƒé™è¡¨**: sys_permission
- **ç”¨æˆ·è§’è‰²å…³è”è¡¨**: sys_user_role
- **è§’è‰²æƒé™å…³è”è¡¨**: sys_role_permission

## 7. æ€»ç»“

æœ¬ç³»ç»Ÿå®ç°äº†å®Œæ•´çš„OAuth2è®¤è¯æˆæƒæœºåˆ¶ï¼Œç»“åˆSpring Securityçš„å¼ºå¤§åŠŸèƒ½å’Œè‡ªå®šä¹‰ä¸šåŠ¡é€»è¾‘ï¼Œæä¾›äº†å®‰å…¨ã€å¯é ã€æ˜“æ‰©å±•çš„è®¤è¯æˆæƒè§£å†³æ–¹æ¡ˆã€‚é€šè¿‡JWT Tokenæºå¸¦æƒé™ä¿¡æ¯ï¼Œå®ç°äº†æ— çŠ¶æ€çš„åˆ†å¸ƒå¼æƒé™éªŒè¯ï¼Œæ”¯æŒç»†ç²’åº¦çš„æƒé™æ§åˆ¶å’ŒåŠ¨æ€æƒé™ç®¡ç†ã€‚